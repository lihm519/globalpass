name: Daily E-SIM Data Scraper

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨ 4:00 è¿è¡Œï¼ˆUTC 20:00ï¼‰
    - cron: '0 20 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  scrape-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 pymysql
      
      - name: Run scraper and update database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python scripts/daily_scraper.py
      
      - name: Export data to JSON
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python scripts/export_to_json.py
      
      - name: Commit and push JSON data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet client/public/data/; then
            echo "No changes to commit"
          else
            git add client/public/data/
            git commit -m "chore: update E-SIM data [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push origin main
          fi
      
      - name: Send failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: 'GlobalPass çˆ¬è™«è¿è¡Œå¤±è´¥ âŒ'
          to: lihm519@gmail.com
          from: GlobalPass Bot <noreply@globalpass.com>
          body: |
            GlobalPass æ¯æ—¥çˆ¬è™«è¿è¡Œå¤±è´¥ï¼
            
            â° æ—¶é—´: ${{ github.event.repository.updated_at }}
            ğŸ“¦ ä»“åº“: ${{ github.repository }}
            ğŸ”— è¿è¡Œæ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            è¯·æ£€æŸ¥æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚
      
      - name: Create job summary
        if: always()
        run: |
          echo "## ğŸ“Š GlobalPass æ¯æ—¥æ•°æ®æŠ“å–" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â° **è¿è¡Œæ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S UTC') (åŒ—äº¬æ—¶é—´ $(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S'))" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **çŠ¶æ€**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### æŠ“å–èŒƒå›´" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸŒ å›½å®¶æ•°é‡: 20 ä¸ªçƒ­é—¨å›½å®¶" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“¦ æ•°æ®æº: Airalo" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ’¾ å­˜å‚¨: ç›´æ¥æ›´æ–°æ•°æ®åº“" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **çŠ¶æ€**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“§ å·²å‘é€å‘Šè­¦é‚®ä»¶åˆ° lihm519@gmail.com" >> $GITHUB_STEP_SUMMARY
          fi
