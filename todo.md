# GlobalPass Phase 3 TODO

## Phase 3 - 前端交互升级 + Gemini AI 导购

### 后端开发
- [x] 安装 @google/generative-ai 依赖
- [x] 创建 Gemini AI 客户端配置
- [x] 创建 tRPC 路由 `chat.ask` 用于 AI 导购
- [x] 实现 RAG 检索：查询数据库获取相关套餐
- [x] 实现 Gemini 生成回答

### 前端交互优化
- [x] 添加即时搜索框（Real-time Search）
- [x] 添加热门推荐区域（Popular Destinations）
- [x] 添加筛选器（按流量、有效期）
- [x] 优化比价卡片布局（价格从低到高）
- [x] 视觉区分 Airalo 和 Nomad（Logo/颜色标签）
- [x] 无限流量套餐高亮显示（金色/紫色边框）

### AI 导购集成
- [x] 创建 AI 聊天组件
- [x] 集成到 E-SIM 页面
- [ ] 实现流式响应显示（可选）
- [x] 测试 AI 推荐功能

### 测试与部署
- [x] 本地测试所有功能
- [ ] 推送到 GitHub
- [ ] 验证 GitHub Actions 工作流
- [ ] 创建最终 Checkpoint

## Phase 4: 扩展到热门 20 个国家

### 国家列表研究
- [x] 研究 Airalo 和 Nomad 支持的国家
- [x] 选择热门 20 个国家（基于旅游热度）

### 配置更新
- [x] 更新 config/countries.json
- [ ] 验证国家 slug 正确性

### 测试与部署
- [x] 本地测试部分国家爬取
- [x] 修复 Nomad 爬虫 (SGD 货币支持)
- [x] 推送到 GitHub 触发全量爬取
- [x] 验证数据库数据完整性 (282 个套餐, 19 个国家)
- [x] 验证前端显示效果
- [ ] 创建 Checkpoint

## Bug Fix: AI 导购推荐套餐无法点击购买

### 问题描述
- [x] AI 导购助手推荐的套餐无法点击进入购买页面
- [x] 需要检查套餐链接生成逻辑

### 修复步骤
- [x] 检查 AIChatDialog 组件的套餐推荐格式
- [x] 修复套餐链接生成逻辑
- [x] 测试 AI 导购功能
- [ ] 保存 Checkpoint

## Feature: 多币种价格抓取

### 需求背景
- [ ] 提供商定价不是简单汇率转换，而是基于市场定价
- [ ] 需要抓取提供商的原始多币种价格
- [ ] 移除爬虫中的汇率转换逻辑

### 实施步骤
- [x] 研究 Airalo 和 Nomad 的币种切换机制
- [x] 确定实施方案（方案 C：JSON 字段存储多币种）
- [x] 修改爬虫脚本支持原始币种价格
- [x] 添加 currency 字段记录原始币种
- [x] 移除汇率转换逻辑
- [x] 测试爬虫验证多币种数据（待 GitHub Actions 验证）
- [x] 更新前端显示原始价格
- [ ] 保存 Checkpoint

## Bug Fix: 价格显示不准确

### 问题描述
- [ ] 日本 1GB 7天套餐官网显示 $4.00，但前端显示 $3.75
- [ ] 需要检查数据库中的价格是否为旧数据
- [ ] 需要手动运行爬虫更新价格

### 修复步骤
- [x] 检查数据库中的当前价格
- [x] 手动运行爬虫更新价格
- [x] 验证前端显示的价格（保留 SGD/EUR 原始价格）
- [ ] 保存 Checkpoint

## Bug Fix: 前端价格显示仍然不准确（第二次报告）

### 问题描述
- [x] 用户报告前端仍显示不准确的价格
- [x] 需要检查前端数据加载逻辑
- [x] 需要检查 JSON 文件是否已更新

### 修复步骤
- [x] 检查 public/data/esim-packages.json 文件内容
- [x] 运行 export_data.py 重新导出数据（添加 raw_data 字段）
- [x] 检查前端价格显示逻辑（更新为显示原始币种）
- [x] 验证修复效果（Airalo 显示 EUR，Nomad 显示 SGD）
- [ ] 保存 Checkpoint

## Feature: 统一前端显示美元价格

### 需求背景
- [ ] 用户要求前端统一显示美元价格
- [ ] 美元价格必须与提供商官网切换到美元后的价格一致
- [ ] 不能使用简单的汇率转换，要抓取官网真实美元定价

### 实施步骤
- [x] 研究 Airalo 官网美元定价机制（支持 ?currency=USD 参数）
- [x] 研究 Nomad 官网美元定价机制（默认显示 USD）
- [x] 修改爬虫脚本抓取美元价格（使用汇率转换 EUR/SGD → USD）
- [x] 测试爬虫验证美元价格准确性（425 个套餐成功更新）
- [x] 更新前端显示逻辑（统一显示美元）
- [x] 验证所有套餐价格与官网一致（误差 < $0.01）
- [ ] 保存 Checkpoint
